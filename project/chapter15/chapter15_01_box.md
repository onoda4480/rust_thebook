# Chapter 15-1: Box<T> - ヒープにデータを配置

## Box<T> とは？

**ヒープにデータを配置するスマートポインタ**

```rust
let b = Box::new(5);
```

---

## Box<T> の特徴

| 特徴 | 説明 |
|------|------|
| **ヒープ割り当て** | データをヒープに配置 |
| **所有権** | データを所有する |
| **スタックのポインタ** | スタックには小さいポインタだけ |
| **自動解放** | スコープを出ると自動的に解放 |

---

## なぜ Box<T> を使うのか？

### 1. コンパイル時にサイズが不明な型

```rust
// 再帰的な型（Cons List）
enum List {
    Cons(i32, Box<List>),  // Box で包む必要がある
    Nil,
}
```

**理由:** Boxなしでは無限のサイズになってしまう

---

### 2. 大きいデータの所有権移動

```rust
// 大きい配列を移動
let big_data = Box::new([0; 10000]);
// スタックには小さいポインタだけコピーされる
```

**効果:** 大量のデータコピーを避ける

---

### 3. トレイトオブジェクト

```rust
// 異なる型を同じコレクションに入れる
let shapes: Vec<Box<dyn Shape>> = vec![
    Box::new(Circle { radius: 5.0 }),
    Box::new(Rectangle { width: 3.0, height: 4.0 }),
];
```

---

## メモリレイアウト

### 通常の値（スタック）
```
スタック
┌──────┐
│  5   │
└──────┘
```

### Box<T>（ヒープ）
```
スタック          ヒープ
┌──────┐        ┌──────┐
│ ptr  │───────>│  5   │
└──────┘        └──────┘
```

---

## Box<T> の基本操作

### 作成
```rust
let b = Box::new(5);
```

### 参照外し
```rust
let x = *b;  // 5
```

### ドロップ
```rust
{
    let b = Box::new(5);
}  // ← ここでヒープのデータが自動解放
```

---

## Cons List の例

### 問題：無限サイズ
```rust
enum List {
    Cons(i32, List),  // ❌ コンパイルエラー！
    Nil,
}
```

### 解決：Box を使う
```rust
enum List {
    Cons(i32, Box<List>),  // ✅ OK!
    Nil,
}

let list = Cons(1, Box::new(Cons(2, Box::new(Nil))));
```

---

## Python との対応

| 概念 | Rust | Python |
|------|------|--------|
| **ヒープ割り当て** | `Box::new(5)` | すべてヒープ |
| **参照外し** | `*b` | 自動 |
| **解放** | 自動（Drop） | GC |

**重要:** Pythonはすべてがヒープだが、Rustは明示的に選択

---

## まとめ

| 項目 | 説明 |
|------|------|
| **用途** | ヒープにデータを配置 |
| **所有権** | データを所有 |
| **サイズ** | スタックには固定サイズのポインタだけ |
| **解放** | スコープを出ると自動 |
| **使い所** | 再帰型、大きいデータ、トレイトオブジェクト |
