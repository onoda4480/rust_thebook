# Chapter 16-3: å…±æœ‰çŠ¶æ…‹ - Mutex ã¨ Arc

## å…±æœ‰çŠ¶æ…‹ã¨ã¯ï¼Ÿ

**è¤‡æ•°ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãŒåŒã˜ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹**

```
ã‚¹ãƒ¬ãƒƒãƒ‰1 â”€â”
          â”œâ”€â”€â†’ å…±æœ‰ãƒ‡ãƒ¼ã‚¿
ã‚¹ãƒ¬ãƒƒãƒ‰2 â”€â”˜
```

---

## Mutex<T> - ç›¸äº’æ’ä»–

### Mutex = Mutual Exclusionï¼ˆç›¸äº’æ’ä»–ï¼‰
= **1åº¦ã«1äººã—ã‹ä½¿ãˆãªã„ç®±**

```rust
use std::sync::Mutex;

let m = Mutex::new(5);
//          ç®±ã«5ã‚’å…¥ã‚Œã‚‹
//          éµãŒã‹ã‹ã£ã¦ã„ã‚‹ğŸ”’
```

---

## Mutex ã®ä½¿ã„æ–¹

```rust
let m = Mutex::new(5);

{
    let mut num = m.lock().unwrap();  // ğŸ”“ ã‚«ã‚®ã‚’å–ã‚‹
    *num = 6;                         // ä¸­èº«ã‚’å¤‰æ›´
}  // â† ğŸ”’ è‡ªå‹•çš„ã«ã‚«ã‚®ã‚’è¿”ã™ï¼ˆDropï¼‰

println!("m = {:?}", m);  // Mutex { data: 6 }
```

---

## Mutex ã®å‹•ä½œï¼ˆ4ã‚¹ãƒ†ãƒƒãƒ—ï¼‰

### 1. ä½œæˆ
```rust
let m = Mutex::new(5);
```
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mutex ğŸ”’ â”‚
â”‚  ä¸­: 5   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ãƒ­ãƒƒã‚¯å–å¾—
```rust
let mut num = m.lock().unwrap();
```
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mutex ğŸ”“ â”‚ â† ã‚«ã‚®ãŒé–‹ã„ãŸ
â”‚  ä¸­: 5   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘
     â”‚
   numï¼ˆMutexGuardï¼‰
```

### 3. å€¤ã‚’å¤‰æ›´
```rust
*num = 6;
```
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mutex ğŸ”“ â”‚
â”‚  ä¸­: 6   â”‚ â† å¤‰æ›´
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. ã‚¹ã‚³ãƒ¼ãƒ—ã‚’å‡ºã‚‹
```rust
}  // num ãŒãƒ‰ãƒ­ãƒƒãƒ—
```
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mutex ğŸ”’ â”‚ â† ã‚«ã‚®ãŒè¿”ã•ã‚ŒãŸ
â”‚  ä¸­: 6   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãªãœ `*num` ãªã®ã‹ï¼Ÿ

### å‹ã‚’è¿½ã†

```rust
let m = Mutex::new(5);          // Mutex<i32>
let num = m.lock().unwrap();    // MutexGuard<i32>
*num = 6;                       // i32 ã«ä»£å…¥
```

**MutexGuard ã¯ã‚¹ãƒãƒ¼ãƒˆãƒã‚¤ãƒ³ã‚¿**
- `Deref` ãƒˆãƒ¬ã‚¤ãƒˆã‚’å®Ÿè£…
- `*` ã§å‚ç…§å¤–ã—ã—ã¦ `i32` ã«ã‚¢ã‚¯ã‚»ã‚¹

---

## å†…éƒ¨å¯å¤‰æ€§

### counter ã¯ä¸å¤‰ãªã®ã«ä¸­èº«ã‚’å¤‰æ›´ã§ãã‚‹

```rust
let counter = Mutex::new(0);  // mut ãªã—ï¼
//  ^^^^^^^
//  ä¸å¤‰

let mut num = counter.lock().unwrap();
*num += 1;  // ã§ã‚‚å¤‰æ›´ã§ãã‚‹ï¼
```

**ç†ç”±:** Mutex ãŒå†…éƒ¨å¯å¤‰æ€§ã‚’æä¾›ï¼ˆRefCell ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰

---

## Arc<T> - ã‚¹ãƒ¬ãƒƒãƒ‰é–“ã§å…±æœ‰

### å•é¡Œï¼šMutex ã ã‘ã§ã¯ä¸ååˆ†

```rust
let counter = Mutex::new(0);

thread::spawn(move || {
    let mut num = counter.lock().unwrap();
    *num += 1;
});
// counter ã®æ‰€æœ‰æ¨©ãŒç§»å‹•ã—ãŸ

thread::spawn(move || {
    let mut num = counter.lock().unwrap();  // âŒ ã‚‚ã†ãªã„
    *num += 1;
});
```

---

### Rc<T> ã‚‚ä½¿ãˆãªã„

```rust
let counter = Rc::new(Mutex::new(0));
let counter1 = Rc::clone(&counter);

thread::spawn(move || {
    // ...  âŒ ã‚¨ãƒ©ãƒ¼ï¼
});
// ã‚¨ãƒ©ãƒ¼: `Rc<Mutex<i32>>` cannot be sent between threads safely
```

**ç†ç”±:** Rc ã¯ã‚¹ãƒ¬ãƒƒãƒ‰å®‰å…¨ã§ãªã„

---

### è§£æ±ºç­–ï¼šArc<T>

```rust
use std::sync::Arc;

let counter = Arc::new(Mutex::new(0));
let counter1 = Arc::clone(&counter);

thread::spawn(move || {
    let mut num = counter1.lock().unwrap();
    *num += 1;
});  // âœ… OK!
```

---

## Rc vs Arc

| é …ç›® | Rc | Arc |
|------|-----|-----|
| **ç”¨é€”** | ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ¬ãƒƒãƒ‰ | ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ |
| **ã‚¹ãƒ¬ãƒƒãƒ‰å®‰å…¨** | âŒ | âœ… |
| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹** | é€Ÿã„ | å°‘ã—é…ã„ |
| **å‚ç…§ã‚«ã‚¦ãƒ³ãƒˆ** | æ™®é€šã®æ•´æ•° | ã‚¢ãƒˆãƒŸãƒƒã‚¯æ“ä½œ |

**Arc = Atomically Reference Counted**

---

## è¤‡æ•°ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã®ä½¿ç”¨ä¾‹

```rust
use std::sync::{Arc, Mutex};
use std::thread;

let counter = Arc::new(Mutex::new(0));
let mut handles = vec![];

for _ in 0..10 {
    let counter = Arc::clone(&counter);
    let handle = thread::spawn(move || {
        let mut num = counter.lock().unwrap();
        *num += 1;
    });
    handles.push(handle);
}

for handle in handles {
    handle.join().unwrap();
}

println!("Result: {}", *counter.lock().unwrap());
// å‡ºåŠ›: Result: 10
```

---

## ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ã®ãƒªã‚¹ã‚¯

### ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ã¨ã¯ï¼Ÿ

**2ã¤ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãŒãŠäº’ã„ã®ãƒ­ãƒƒã‚¯ã‚’å¾…ã¡åˆã£ã¦ã—ã¾ã†çŠ¶æ…‹**

```rust
// å±é™ºãªä¾‹
let resource1 = Arc::new(Mutex::new(1));
let resource2 = Arc::new(Mutex::new(2));

// ã‚¹ãƒ¬ãƒƒãƒ‰1: A â†’ B ã®é †ã§ãƒ­ãƒƒã‚¯
// ã‚¹ãƒ¬ãƒƒãƒ‰2: B â†’ A ã®é †ã§ãƒ­ãƒƒã‚¯
// â†’ ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ï¼ğŸ’€
```

---

### ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ã®æµã‚Œ

```
ã‚¹ãƒ¬ãƒƒãƒ‰1: resource1 ã‚’ãƒ­ãƒƒã‚¯ ğŸ”“
ã‚¹ãƒ¬ãƒƒãƒ‰2:                        resource2 ã‚’ãƒ­ãƒƒã‚¯ ğŸ”“

ã‚¹ãƒ¬ãƒƒãƒ‰1:                        resource2 ã‚’å¾…ã¤... â³
ã‚¹ãƒ¬ãƒƒãƒ‰2: resource1 ã‚’å¾…ã¤... â³

â†“ ãŠäº’ã„ã«æ°¸é ã«å¾…ã¤ï¼ˆãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ï¼‰ğŸ’€
```

---

### ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ã‚’é˜²ãæ–¹æ³•

1. **ãƒ­ãƒƒã‚¯ã®é †åºã‚’çµ±ä¸€**
   ```rust
   // å…¨ã‚¹ãƒ¬ãƒƒãƒ‰ã§ A â†’ B ã®é †
   ```

2. **ãƒ­ãƒƒã‚¯ã‚’æ—©ãè§£æ”¾**
   ```rust
   {
       let num = counter.lock().unwrap();
       *num += 1;
   }  // ã™ãã«è§£æ”¾
   ```

3. **try_lock ã‚’ä½¿ã†**
   ```rust
   match mutex.try_lock() {
       Ok(guard) => { /* ... */ }
       Err(_) => { /* ãƒ­ãƒƒã‚¯å–å¾—å¤±æ•— */ }
   }
   ```

---

## Rust ãŒé˜²ã’ã‚‹ã“ã¨ vs é˜²ã’ãªã„ã“ã¨

### âœ… ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«é˜²ã’ã‚‹
- ãƒ‡ãƒ¼ã‚¿ç«¶åˆ
- æ‰€æœ‰æ¨©é•å
- ãƒ€ãƒ³ã‚°ãƒªãƒ³ã‚°ãƒã‚¤ãƒ³ã‚¿

### âŒ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«é˜²ã’ãªã„
- ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯
- ç„¡é™ãƒ«ãƒ¼ãƒ—
- ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ãƒã‚°

**é‡è¦:** ãƒ­ã‚¸ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼ã¯è‡ªåˆ†ã§æ°—ã‚’ä»˜ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹

---

## ã¾ã¨ã‚

| é …ç›® | èª¬æ˜ |
|------|------|
| **Mutex<T>** | 1åº¦ã«1äººã—ã‹ä½¿ãˆãªã„ç®± |
| **lock()** | ã‚«ã‚®ã‚’å–ã‚‹ï¼ˆãƒ­ãƒƒã‚¯ç²å¾—ï¼‰ |
| **MutexGuard** | ã‚¹ãƒãƒ¼ãƒˆãƒã‚¤ãƒ³ã‚¿ï¼ˆè‡ªå‹•è§£æ”¾ï¼‰ |
| **Arc<T>** | ã‚¹ãƒ¬ãƒƒãƒ‰é–“ã§å…±æœ‰ï¼ˆRc ã®ãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ç‰ˆï¼‰ |
| **å†…éƒ¨å¯å¤‰æ€§** | ä¸å¤‰ã§ã‚‚ä¸­èº«ã‚’å¤‰æ›´ã§ãã‚‹ |
| **ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯** | Rust ã¯é˜²ã’ãªã„ï¼ˆæ³¨æ„ãŒå¿…è¦ï¼‰ |

**é‡è¦:** Arc<Mutex<T>> ãŒãƒãƒ«ãƒã‚¹ãƒ¬ãƒƒãƒ‰ã®å…±æœ‰çŠ¶æ…‹ã®åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼
