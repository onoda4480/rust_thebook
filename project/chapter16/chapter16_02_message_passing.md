# Chapter 16-2: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ãƒƒã‚·ãƒ³ã‚° - ãƒãƒ£ãƒãƒ«ã§ãƒ‡ãƒ¼ã‚¿ã‚’é€å—ä¿¡

## ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‘ãƒƒã‚·ãƒ³ã‚°ã¨ã¯ï¼Ÿ

**ã‚¹ãƒ¬ãƒƒãƒ‰é–“ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€å—ä¿¡ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰**

```
ã‚¹ãƒ¬ãƒƒãƒ‰1 â”€â”€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸â”€â”€> ãƒãƒ£ãƒãƒ« â”€â”€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸â”€â”€> ã‚¹ãƒ¬ãƒƒãƒ‰2
```

**æ ¼è¨€:**
> ã€Œãƒ¡ãƒ¢ãƒªã‚’å…±æœ‰ã™ã‚‹ã“ã¨ã§é€šä¿¡ã™ã‚‹ãªã€é€šä¿¡ã™ã‚‹ã“ã¨ã§ãƒ¡ãƒ¢ãƒªã‚’å…±æœ‰ã—ã‚ã€

---

## ãƒãƒ£ãƒãƒ«ï¼ˆmpscï¼‰

### mpsc = Multiple Producer, Single Consumer
- **Multiple Producer**: è¤‡æ•°ã®é€ä¿¡è€…
- **Single Consumer**: å˜ä¸€ã®å—ä¿¡è€…

```rust
use std::sync::mpsc;

let (tx, rx) = mpsc::channel();
//   â†‘   â†‘
//   |   â””â”€ Receiverï¼ˆå—ä¿¡æ©Ÿï¼‰
//   â””â”€â”€â”€â”€â”€ Transmitterï¼ˆé€ä¿¡æ©Ÿï¼‰
```

---

## ãƒãƒ£ãƒãƒ«ã®åŸºæœ¬

### é€ä¿¡ã¨å—ä¿¡

```rust
use std::sync::mpsc;
use std::thread;

fn main() {
    let (tx, rx) = mpsc::channel();

    thread::spawn(move || {
        let val = String::from("hi");
        tx.send(val).unwrap();  // é€ä¿¡
    });

    let received = rx.recv().unwrap();  // å—ä¿¡
    println!("Got: {}", received);
}
```

---

## tx ã¨ rx

### tx = Transmitterï¼ˆé€ä¿¡æ©Ÿï¼‰
```rust
tx.send(data).unwrap();
```
- ãƒ‡ãƒ¼ã‚¿ã‚’**é€ã‚‹**å´
- ãƒãƒ£ãƒãƒ«ã«**å…¥åŠ›**
- è¤‡æ•°ä½œã‚Œã‚‹ï¼ˆcloneå¯èƒ½ï¼‰

### rx = Receiverï¼ˆå—ä¿¡æ©Ÿï¼‰
```rust
let data = rx.recv().unwrap();
```
- ãƒ‡ãƒ¼ã‚¿ã‚’**å—ã‘å–ã‚‹**å´
- ãƒãƒ£ãƒãƒ«ã‹ã‚‰**å‡ºåŠ›**
- 1ã¤ã ã‘ï¼ˆcloneã§ããªã„ï¼‰

---

## ãƒãƒ£ãƒãƒ«ã®ã‚¤ãƒ¡ãƒ¼ã‚¸

```
é€ä¿¡å´(tx)              ãƒãƒ£ãƒãƒ«              å—ä¿¡å´(rx)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ thread â”‚â”€â”€sendâ”€â”€â”€â”€â”€>â”‚ â–‘â–‘â–‘â–‘â–‘â–‘ â”‚â”€â”€recvâ”€â”€â”€>â”‚  main  â”‚
â”‚        â”‚            â”‚ â–‘â–‘â–‘â–‘â–‘â–‘ â”‚           â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   å…¥åŠ›                  ãƒ‘ã‚¤ãƒ—               å‡ºåŠ›
```

---

## send() ã®é‡è¦ãªç‰¹æ€§

### æ‰€æœ‰æ¨©ã‚’å¥ªã†

```rust
let val = String::from("hi");
tx.send(val).unwrap();  // val ã®æ‰€æœ‰æ¨©ãŒç§»å‹•
println!("{}", val);    // âŒ ã‚¨ãƒ©ãƒ¼ï¼val ã¯ã‚‚ã†ãªã„
```

**ç†ç”±:** ãƒ‡ãƒ¼ã‚¿ç«¶åˆã‚’é˜²ããŸã‚

---

## ä¸¦è¡Œæ€§ã®ãƒŸã‚¹

### ã‚‚ã— send å¾Œã«ä½¿ãˆãŸã‚‰...

```rust
// ã‚¹ãƒ¬ãƒƒãƒ‰1
let mut val = String::from("hi");
tx.send(val).unwrap();
val.push_str(" world");  // ã‚‚ã—ã“ã‚ŒãŒã§ããŸã‚‰...

// ã‚¹ãƒ¬ãƒƒãƒ‰2
let mut received = rx.recv().unwrap();
received.push_str("!");  // åŒæ™‚ã«å¤‰æ›´

// ä¸¡æ–¹ã¨ã‚‚åŒã˜ãƒ¡ãƒ¢ãƒªã‚’å¤‰æ›´ â†’ ãƒ‡ãƒ¼ã‚¿ç«¶åˆï¼ğŸ’¥
```

### Rust ãŒé˜²ã

```rust
tx.send(val).unwrap();  // æ‰€æœ‰æ¨©ãŒç§»å‹•
val.push_str(" world"); // âŒ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼
```

**ã“ã‚Œã¯æœ¬è³ªçš„ã«ä¸¦è¡Œæ€§ã®ãƒŸã‚¹ï¼**
- æ‰€æœ‰æ¨©ã‚·ã‚¹ãƒ†ãƒ ãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«é˜²ã

---

## recv vs try_recv

### recv(): ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ï¼ˆå¾…ã¤ï¼‰

```rust
let msg = rx.recv().unwrap();
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ¥ã‚‹ã¾ã§ãšã£ã¨å¾…ã¤â³
```

**ç”¨é€”:** ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã™ã‚‹ã“ã¨**ã ã‘**ãŒä»•äº‹ã®å ´åˆ

---

### try_recv(): ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼ˆã™ãè¿”ã™ï¼‰

```rust
match rx.try_recv() {
    Ok(msg) => println!("å—ä¿¡: {}", msg),
    Err(_) => println!("ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—"),
}
// ã™ãã«çµæœã‚’è¿”ã™
```

**ç”¨é€”:** ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾…ã¡ãªãŒã‚‰**ä»–ã®ä½œæ¥­ã‚‚ã—ãŸã„**å ´åˆ

---

## ä½¿ã„åˆ†ã‘

### recv ã‚’ä½¿ã†ä¾‹
```rust
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾…ã¤ã ã‘
for received in rx {
    println!("å—ä¿¡: {}", received);
}
```

### try_recv ã‚’ä½¿ã†ä¾‹
```rust
// ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
loop {
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
    match rx.try_recv() {
        Ok(msg) => handle_message(msg),
        Err(_) => {},  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—
    }

    // ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯
    update_game();
    render();
}
```

---

## è¤‡æ•°ã®å€¤ã‚’é€ä¿¡

```rust
let (tx, rx) = mpsc::channel();

thread::spawn(move || {
    let vals = vec![
        String::from("hi"),
        String::from("from"),
        String::from("the"),
        String::from("thread"),
    ];

    for val in vals {
        tx.send(val).unwrap();
        thread::sleep(Duration::from_secs(1));
    }
});

for received in rx {
    println!("Got: {}", received);
}
```

**å‡ºåŠ›:**
```
Got: hi      â† 1ç§’å¾Œ
Got: from    â† 1ç§’å¾Œ
Got: the     â† 1ç§’å¾Œ
Got: thread  â† 1ç§’å¾Œ
```

---

## è¤‡æ•°ã®é€ä¿¡è€…

```rust
let (tx, rx) = mpsc::channel();

let tx1 = tx.clone();
thread::spawn(move || {
    tx1.send("from thread 1").unwrap();
});

let tx2 = tx.clone();
thread::spawn(move || {
    tx2.send("from thread 2").unwrap();
});

for received in rx {
    println!("Got: {}", received);
}
```

---

## å›³è§£ï¼šè¤‡æ•°ã®é€ä¿¡è€…

```
thread 1 (tx1) â”€â”
                â”œâ”€â”€â†’ ãƒãƒ£ãƒãƒ« â”€â”€â†’ rx (å—ä¿¡è€…ã¯1ã¤)
thread 2 (tx2) â”€â”¤
                â”‚
thread 3 (tx3) â”€â”˜
```

---

## ã¾ã¨ã‚

| é …ç›® | èª¬æ˜ |
|------|------|
| **mpsc** | Multiple Producer, Single Consumer |
| **tx** | é€ä¿¡æ©Ÿï¼ˆå…¥åŠ›ï¼‰ |
| **rx** | å—ä¿¡æ©Ÿï¼ˆå‡ºåŠ›ï¼‰ |
| **send()** | æ‰€æœ‰æ¨©ã‚’å¥ªã† |
| **recv()** | ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦å¾…ã¤ |
| **try_recv()** | ã™ãã«çµæœã‚’è¿”ã™ |

**é‡è¦:** ãƒãƒ£ãƒãƒ«ã¯æ‰€æœ‰æ¨©ã®è»¢é€ã€ãƒ¡ãƒ¢ãƒªã®å…±æœ‰ã§ã¯ãªã„ï¼
